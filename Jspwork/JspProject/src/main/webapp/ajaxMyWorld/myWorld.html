<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Dongle&family=Gaegu&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@100..900&family=Noto+Serif+KR&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<title>Insert title here</title>
	<style type="text/css">
		div.hello{
			position: absolute;
			border: 0px solid gray;
			font-family: "Nanum Pen Script";
			font-size: 1.5em;
		}
		
		div.button{
			left: 150px;
			top: 30px;
			width: 400px;
			height: 100px;
			line-height: 100px;
			text-align: center;
		}
		
		div.addform,div.updateform{
			left: 100px;
			top: 150px;
			width: 500px;
			height: 400px;
			padding: 20px 20px;
		}
		
		img.avata{
			cursor: pointer;
		}
		
		img.uavata{
			cursor: pointer;
		}
		
		img.select{
			border: 2px solid red;
		}
		
		div.list{
			left: 800px;
			top: 100px;
			width: 600px;
			height: 1000px;
			padding: 20px 20px;
		}
		
		span.day{
			color: #bbb;
			float: right;
		}
		
		i.bi{
			float: right;
			padding-right: 10px;
			cursor: pointer;
		}
	</style>
	<script type="text/javascript">
		$(function(){
			list();
			
			//처음에 추가폼 없는상태로
			$("div.addform").hide();
			$("div.updateform").hide();
			
			$("#btnadd").click(function(){
				$("div.addform").slideToggle("fast");
				$("div.updateform").hide();
			});
			
			//아바타 이미지에 기본하나 select클래스 추가
			$("img.avata").eq(2).addClass("select");
			
			//2번아바타의 src값을 얻어서 input태그에 추가하기
			$("#avata").val($("img.avata").eq(2).attr("src"));
			
			//아바타 선택시 값변경하기
			$("img.avata").click(function(){
				$(this).siblings().removeClass("select");
				$(this).addClass("select");
				$("#avata").val($(this).attr("src"));
			});
			
			//추가폼 저장
			$("#dbSave").click(function(){
				var data=$("#addfrm").serialize();
				
				$.ajax({
					type:"post",
					url:"worldInsert.jsp",
					dataType:"html",
					data:data,
					success:function(){
						//방명록 저장 후 리스트 재호출
						list();
						
						//입력값 초기화
						$("#writer").val("");
						$("#content").val("");
						//아바타 초기화
						$("img.avata").removeClass("select");
						$("img.avata").eq(2).addClass("select");
						$("#avata").val($("img.avata").eq(2).attr("src"));
					}
				});
			});
			
			//삭제
		    $(document).on("click","i.del",function() {

		        $.ajax({
		            type:"get",
		            url:"worldDelete.jsp",
		            dataType:"html",
		            data:{"num":$(this).attr("num")},
		            success:function() {
		            	//리스트 재호출
		                list();
		            }
		        });
		    });
			
		  	//수정시 아바타 선택시 값변경
			$("img.uavata").click(function(){
				$(this).siblings().removeClass("select");
				$(this).addClass("select");
				$("#uavata").val($(this).attr("src"));
			});
		  	
			//목록의 수정버튼
			$(document).on("click","i.edit",function(){
				var num=$(this).attr("num");
				
				//폼의 unum에 num넣기
				$("#unum").val(num);
				$.ajax({
					type:"get",
					url:"worldGetData.jsp",
					dataType:"json",
					data:{"num":num},
					success:function(res){
						//수정폼 태그안에 넣어준다
						$("#unum").val(res.num);
						$("#uwriter").val(res.writer);
						$("#ucontent").val(res.content);
						$("#uavata").val(res.avata);
						
						//해당이미지에 select클래스추가
						$("img.uavata").each(function(i,ele){
							if($(this).attr("src")==res.avata){
								$(this).addClass("select");
							}else{
								$(this).removeClass("select");
							}
						});
						
						//추가폼이 있으면 숨기고 수정폼을 나타낸다
						$("div.addform").hide();
						$("div.updateform").show();
					}
				});
			});
			
			//수정
			$("#dbUpdate").click(function(){
				var data=$("#updatefrm").serialize();
				
				$.ajax({
					type:"post",
					url:"worldUpdate.jsp",
					dataType:"html",
					data:data,
					success:function(){
						//방명록 저장 후 리스트 재호출
						list();
					}
				});
			});
		});
		
		//사용자 함수 list
		function list(){
			$.ajax({
				type:"get",
				url:"worldList.jsp",
				dataType:"json",
				success:function(data){
					var s="";
					
					if(data.length==0){
						s+="<h3 class='alert alert-info'>저장된 방명록이 없습니다</h3>";
					}else{
						$.each(data,function(i,elt){
							s+="<i class='bi bi-trash3-fill del' num='"+elt.num+"'></i>";
							s+="<i class='bi bi-pencil-square edit' num='"+elt.num+"'></i>";
							s+="<table class='table table-bordered'>";
							s+="<tr height='100'><td>";
							s+="<span class='writer'>작성자: "+elt.writer+"</span>";
							s+="<span class='day'>"+elt.writeday+"</span>";
							s+="<br>";
							s+="<pre>"+elt.content;
							s+="<img src='"+elt.avata+"' align='right' width='80'>";
							s+="</pre>";
							s+="</td></tr>";
							s+="</table><br>";
						});
					}
					$("div.list").html(s);
				}
			});
		}
		
	</script>
</head>
<body>
	<div class="hello button">
		<button type="button" class="btn btn-danger" id="btnadd" style="width: 120px;">방명록추가</button>	
	</div>
	<div class="hello addform">
		<form id="addfrm">
			<table class="table table-bordered">
				<caption align="top"><b>방명록추가</b></caption>
					<tr>
						<th>작성자</th>
						<td>
							<input type="text" class="form-control input-sm" name="writer" id="writer" style="width: 120px;">
						</td>
					</tr>
					<tr>
						<th>남기는말</th>
						<td>
							<textarea style="width: 300px; height: 100px;" class="form-control" name="content" id="content"></textarea>
						</td>
					</tr>
					<tr>
						<th>아바타</th>
						<td>
							<input type="hidden" name="avata" id="avata">
							<script type="text/javascript">
								for(var i=1;i<11;i++){
									document.write("<img src='../image/avata/b"+i+".png' style='width: 50px;' class='avata'>");
									if(i==5){
										document.write("<br>");
									}
								}
							</script>
						</td>
					</tr>
					<tr>
						<td colspan="2" align="center">
							<button type="button" class="btn btn-info" id="dbSave">DB저장하기</button>
						</td>
					</tr>
			</table>
		</form>
	</div>
	
	<div class="hello updateform">
		<form id="updatefrm">
			<!-- hidden:num 수정폼에서 가장중요함 항상보내기 -->
			<input type="hidden" id="unum" name="unum">
			<table class="table table-bordered">
				<caption align="top"><b>방명록수정</b></caption>
					<tr>
						<th>작성자</th>
						<td>
							<input type="text" class="form-control input-sm" name="uwriter" id="uwriter" style="width: 120px;">
						</td>
					</tr>
					<tr>
						<th>남기는말</th>
						<td>
							<textarea style="width: 300px; height: 100px;" class="form-control" name="ucontent" id="ucontent"></textarea>
						</td>
					</tr>
					<tr>
						<th>아바타</th>
						<td>
							<input type="hidden" name="uavata" id="uavata">
							<script type="text/javascript">
								for(var i=1;i<11;i++){
									document.write("<img src='../image/avata/b"+i+".png' style='width: 50px;' class='uavata'>");
									if(i==5){
										document.write("<br>");
									}
								}
							</script>
						</td>
					</tr>
					<tr>
						<td colspan="2" align="center">
							<button type="button" class="btn btn-info" id="dbUpdate">DB수정하기</button>
						</td>
					</tr>
			</table>
		</form>
	</div>
	
	<div class="hello list">list</div>
</body>
</html>